<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Bar Charts â€” Interactive Worksheet</title>
    <style>
        :root {
            --fx-paper: #FFFCF0; --fx-base-50: #F2F0E5; --fx-base-100: #EFEBD4;
            --fx-base-150: #E6E2CC; --fx-base-200: #DAD4BA; --fx-base-300: #C8BFA1;
            --fx-base-400: #B5A988; --fx-base-500: #9C8F70; --fx-base-600: #847759;
            --fx-base-700: #6F6144; --fx-base-800: #575142; --fx-base-850: #403E39;
            --fx-base-900: #343331; --fx-base-950: #1C1B1A; --fx-black: #100F0F;
            --fx-red: #D14D41; --fx-orange: #DA702C; --fx-yellow: #D0A215;
            --fx-green: #879A39; --fx-cyan: #3AA99F; --fx-blue: #4385BE;
            --fx-purple: #8B7EC8; --fx-magenta: #CE5D97;
            --bg-primary: var(--fx-paper); --bg-secondary: var(--fx-base-50);
            --bg-tertiary: var(--fx-base-100); --text-primary: var(--fx-base-950);
            --text-secondary: var(--fx-base-700); --text-muted: var(--fx-base-600);
            --border-color: var(--fx-base-200); --accent-primary: var(--fx-blue);
            --shadow: rgba(28,27,26,0.1);
            --color-ug: #4385BE; --color-us: #66800B; --color-k: #D14D41;
            --color-wext: #8B7EC8; --color-q: #DA702C; --color-echem: #CE5D97;
        }
        [data-theme="dark"] {
            --bg-primary: var(--fx-black); --bg-secondary: var(--fx-base-950);
            --bg-tertiary: var(--fx-base-900); --text-primary: var(--fx-paper);
            --text-secondary: var(--fx-base-200); --text-muted: var(--fx-base-400);
            --border-color: var(--fx-base-850); --accent-primary: #4385BE;
            --shadow: rgba(16,15,15,0.3);
            --color-ug: #5BA2E0; --color-us: #98B636; --color-k: #E06050;
            --color-wext: #A899DD; --color-q: #E8863A; --color-echem: #E07AB0;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Fira Code','SF Mono','Monaco','Inconsolata','Roboto Mono', monospace;
            background: var(--bg-primary); color: var(--text-primary);
            line-height: 1.6; padding: 16px;
        }
        .container { max-width: 1100px; margin: 0 auto; }
        header {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 24px 30px; margin-bottom: 16px;
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;
        }
        h1 { font-size: 1.6em; font-weight: 700; }
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .theme-toggle, .reset-all-btn {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 6px 12px; border-radius: 6px;
            cursor: pointer; font-size: 0.8rem; font-family: inherit;
        }
        .theme-toggle:hover, .reset-all-btn:hover { background: var(--accent-primary); color: var(--bg-primary); }
        .progress-bar {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 12px 20px; margin-bottom: 16px;
            display: flex; align-items: center; gap: 12px; font-size: 0.85em;
        }
        .progress-track { flex: 1; height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--color-us); border-radius: 4px; transition: width 0.4s ease; }
        .guide-toggle {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 16px; overflow: hidden;
        }
        .guide-toggle summary {
            padding: 12px 20px; cursor: pointer; font-weight: 600; font-size: 0.95em;
            color: var(--accent-primary); list-style: none;
        }
        .guide-toggle summary::before { content: "â–¶ "; }
        .guide-toggle[open] summary::before { content: "â–¼ "; }
        .guide-content { padding: 0 20px 16px; font-size: 0.85em; color: var(--text-secondary); line-height: 1.8; }
        .guide-content p { margin-bottom: 8px; }
        .problem-card {
            background: var(--bg-secondary); border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 16px; overflow: hidden;
        }
        .problem-header {
            background: var(--bg-tertiary); padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px;
        }
        .problem-header h2 { font-size: 1.15em; font-weight: 700; }
        .problem-status { font-size: 0.8em; padding: 3px 10px; border-radius: 12px; }
        .problem-status.complete { background: var(--color-us); color: #fff; }
        .problem-status.incomplete { background: var(--bg-secondary); color: var(--text-muted); border: 1px solid var(--border-color); }
        .problem-scenario {
            padding: 16px 20px; font-size: 0.9em; color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            border-left: 4px solid var(--accent-primary);
        }
        .part-container { padding: 20px; border-bottom: 1px solid var(--border-color); }
        .part-container:last-child { border-bottom: none; }
        .part-label { font-weight: 700; font-size: 1em; margin-bottom: 6px; }
        .part-desc { font-size: 0.85em; color: var(--text-secondary); margin-bottom: 16px; }
        .system-def {
            display: inline-block; background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 4px; padding: 2px 8px; font-size: 0.8em; margin-bottom: 12px; color: var(--text-muted);
        }
        /* Bar Chart */
        .chart-wrapper {
            display: flex; align-items: center; justify-content: center;
            gap: 4px; flex-wrap: wrap; margin: 12px 0;
        }
        .chart-section { text-align: center; }
        .section-label { font-size: 0.7em; font-weight: 600; color: var(--text-muted); margin-bottom: 4px; letter-spacing: 0.5px; text-transform: uppercase; }
        .bars-row { display: flex; gap: 2px; justify-content: center; }
        .bar-col { display: flex; flex-direction: column; align-items: center; width: 40px; }
        .cells-container { display: flex; flex-direction: column; border: 1px solid var(--border-color); border-radius: 3px; overflow: hidden; }
        .cell {
            width: 38px; height: 24px; border-bottom: 1px solid var(--border-color);
            cursor: pointer; transition: background 0.15s;
        }
        .cell:first-child { border-top: none; }
        .cell:last-child { border-bottom: none; }
        .cell:hover { opacity: 0.8; filter: brightness(1.1); }
        .cell.neg-zone { background: var(--bg-primary); }
        .cell.filled-ug { background: var(--color-ug); }
        .cell.filled-us { background: var(--color-us); }
        .cell.filled-k { background: var(--color-k); }
        .cell.filled-wext { background: var(--color-wext); }
        .cell.filled-q { background: var(--color-q); }
        .cell.filled-echem { background: var(--color-echem); }
        .zero-line { width: 100%; height: 3px; background: var(--text-primary); flex-shrink: 0; }
        .bar-label { font-size: 0.75em; font-weight: 600; margin-top: 4px; color: var(--text-secondary); }
        .bar-label sub { font-size: 0.7em; }
        .operator { font-size: 1.5em; font-weight: 700; padding: 0 6px; color: var(--text-muted); align-self: center; margin-top: 14px; }
        .chart-value { font-size: 0.65em; color: var(--text-muted); margin-top: 1px; min-height: 14px; }
        /* Buttons & Feedback */
        .part-actions { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; align-items: center; }
        .check-btn {
            background: var(--accent-primary); color: #fff; border: none;
            padding: 8px 20px; border-radius: 6px; cursor: pointer;
            font-family: inherit; font-size: 0.85em; font-weight: 600;
        }
        .check-btn:hover { filter: brightness(1.15); }
        .reset-btn {
            background: transparent; color: var(--text-muted); border: 1px solid var(--border-color);
            padding: 8px 16px; border-radius: 6px; cursor: pointer;
            font-family: inherit; font-size: 0.85em;
        }
        .reset-btn:hover { border-color: var(--text-secondary); color: var(--text-secondary); }
        .feedback {
            margin-top: 12px; padding: 12px 16px; border-radius: 6px;
            font-size: 0.85em; display: none; line-height: 1.7;
        }
        .feedback.show { display: block; }
        .feedback.correct { background: rgba(135,154,57,0.15); border: 1px solid var(--color-us); color: var(--color-us); }
        .feedback.incorrect { background: rgba(209,77,65,0.12); border: 1px solid var(--fx-red); color: var(--fx-red); }
        .feedback.partial { background: rgba(208,162,21,0.12); border: 1px solid var(--fx-yellow); color: var(--fx-yellow); }
        .equation-display {
            margin-top: 10px; padding: 10px 14px; background: var(--bg-tertiary);
            border-radius: 6px; font-size: 0.85em; display: none;
        }
        .equation-display.show { display: block; }
        .equation-display .eq-label { font-weight: 600; color: var(--accent-primary); }
        .hint-text { font-size: 0.8em; color: var(--text-muted); font-style: italic; margin-top: 4px; }
        footer {
            background: var(--bg-tertiary); border: 1px solid var(--border-color);
            border-radius: 8px; padding: 16px; text-align: center;
            color: var(--text-muted); font-size: 0.8em; margin-top: 16px;
        }
        /* Diagrams */
        .diagram-container {
            display: flex; justify-content: center; padding: 16px 0 8px;
        }
        .diagram-container svg {
            max-width: 100%; height: auto;
        }
        .diagram-container svg text {
            font-family: 'Fira Code','SF Mono','Monaco','Inconsolata','Roboto Mono', monospace;
        }
        .diagram-container svg .stroke { stroke: var(--text-primary); fill: none; }
        .diagram-container svg .fill-obj { fill: var(--text-secondary); stroke: var(--text-primary); }
        .diagram-container svg .fill-ground { fill: var(--bg-tertiary); stroke: var(--text-primary); }
        .diagram-container svg .fill-spring { fill: var(--color-us); stroke: var(--color-us); opacity: 0.8; }
        .diagram-container svg .txt { fill: var(--text-primary); }
        .diagram-container svg .txt-label { fill: var(--accent-primary); font-weight: 700; }
        .diagram-container svg .txt-dim { fill: var(--text-muted); }
        .diagram-container svg .dashed { stroke-dasharray: 6,4; }
        .diagram-container svg .arrow { fill: var(--fx-red); stroke: var(--fx-red); }
        .diagram-container svg .arrow-v { fill: var(--color-k); stroke: var(--color-k); }
        .diagram-container svg .cord { stroke: var(--fx-purple); stroke-width: 2; fill: none; }
        .part-diagram { padding: 8px 0 4px; display: flex; justify-content: center; }
        .part-diagram svg { max-width: 100%; height: auto; }
        .part-diagram svg text { font-family: 'Fira Code','SF Mono','Monaco','Inconsolata','Roboto Mono', monospace; }
        .part-diagram svg .stroke { stroke: var(--text-primary); fill: none; }
        .part-diagram svg .fill-obj { fill: var(--text-secondary); stroke: var(--text-primary); }
        .part-diagram svg .txt { fill: var(--text-primary); }
        .part-diagram svg .txt-label { fill: var(--accent-primary); font-weight: 700; }
        .part-diagram svg .txt-dim { fill: var(--text-muted); }
        .part-diagram svg .dashed { stroke-dasharray: 6,4; }

        @media (max-width: 700px) {
            .chart-wrapper { gap: 2px; }
            .bar-col { width: 32px; }
            .cell { width: 30px; height: 20px; }
            .operator { font-size: 1.2em; padding: 0 3px; }
            header { padding: 16px; }
            h1 { font-size: 1.3em; }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>âš¡ Energy Bar Charts</h1>
        <div class="header-controls">
            <button class="reset-all-btn" onclick="resetAll()">Reset All</button>
            <button class="theme-toggle" onclick="toggleTheme()"></button>
        </div>
    </header>

    <div class="progress-bar">
        <span>Progress:</span>
        <div class="progress-track"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
        <span id="progressText">0 / 18</span>
    </div>

    <details class="guide-toggle">
        <summary>How to Create Energy Bar Graphs (Reference Guide)</summary>
        <div class="guide-content">
            <p>Energy bar graphs visually track how the <strong>total energy of a system</strong> is stored in different forms at different moments in time.</p>
            <p><strong>Step 1 â€” Define the System:</strong> Decide what's in your system (object, Earth, spring, etc.). Everything outside is the surroundings.</p>
            <p><strong>Step 2 â€” Choose Energy Types:</strong> U<sub>g</sub> (gravitational), U<sub>s</sub> (elastic), K (kinetic), Q (thermal/internal).</p>
            <p><strong>Step 3 â€” Pick Snapshots:</strong> Choose initial and final moments. Label them clearly.</p>
            <p><strong>Step 4 â€” Set a Scale:</strong> The sum of bar heights must equal the total energy. Use the same scale for initial and final.</p>
            <p><strong>Step 5 â€” Draw Initial Bars:</strong> Which energy types are present at the start? Set their heights.</p>
            <p><strong>Step 6 â€” Draw Final Bars:</strong> Use conservation of energy. Total initial + Work = Total final.</p>
            <p><strong>Step 7 â€” Friction:</strong> If friction is present, some mechanical energy becomes thermal energy (Q). The Q bar grows as K and/or U shrink.</p>
            <p><strong>Key Rule:</strong> Click cells in each column to set bar heights. Initial Energy + External Work = Final Energy.</p>
        </div>
    </details>

    <div id="problems"></div>

    <details class="guide-toggle" style="margin-top:16px">
        <summary>ðŸ§ª Sandbox â€” Make Your Own Bar Chart</summary>
        <div style="padding:20px">
            <p style="font-size:0.85em;color:var(--text-secondary);margin-bottom:12px">Create your own scenario. No answer checking â€” just explore energy conservation!</p>
            <div id="sandbox"></div>
        </div>
    </details>

    <footer>Interactive Energy Bar Charts Worksheet â€” AP Physics 1 â€” Energy Transfer Model<br>Â©Modeling Instruction | Digital Version</footer>
</div>

<script>
// â”€â”€â”€ DIAGRAMS â”€â”€â”€
const DIAGRAMS = {

1: `<svg viewBox="0 0 520 280" width="520" height="280" xmlns="http://www.w3.org/2000/svg">
  <!-- Ground -->
  <line x1="20" y1="230" x2="500" y2="230" class="stroke" stroke-width="2"/>
  <!-- Spring wall -->
  <rect x="28" y="210" width="8" height="22" class="fill-ground" stroke-width="1"/>
  <!-- Coiled spring (animated compressedâ†’relaxed) -->
  <path class="fill-spring" fill="none" stroke-width="2.5" stroke-linecap="round">
    <animate attributeName="d" values="M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 48,222 A6,6 0 0,0 60,222 A6,6 0 0,1 72,222 A6,6 0 0,0 84,222 A6,6 0 0,1 96,222 A6,6 0 0,0 108,222;M36,222 A6,6 0 0,1 48,222 A6,6 0 0,0 60,222 A6,6 0 0,1 72,222 A6,6 0 0,0 84,222 A6,6 0 0,1 96,222 A6,6 0 0,0 108,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222" keyTimes="0;0.08;0.22;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
  </path>
  <!-- Track: flat from spring â†’ curves up to meet loop at bottom (270,190) -->
  <path d="M84,230 L180,230 Q220,230 240,210 Q255,197 270,190" class="stroke" stroke-width="2"/>
  <!-- Loop (center 270,140 r=50) -->
  <circle cx="270" cy="140" r="50" class="stroke" stroke-width="2"/>
  <!-- Track exit: from bottom of loop going right and down (faded) -->
  <path d="M270,190 Q310,200 340,220 L450,230" class="stroke" stroke-width="2" opacity="0.25"/>
  <!-- Height indicator -->
  <line x1="35" y1="230" x2="35" y2="85" class="stroke dashed" stroke-width="1" opacity="0.2"/>
  <text x="14" y="160" class="txt-dim" font-size="11" text-anchor="middle" transform="rotate(-90,14,160)">height</text>
  <!-- Ghost at A (next to spring) -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="78" y="216" width="30" height="14" rx="3" stroke-width="1.5" stroke-dasharray="4,3"/>
    <circle cx="84" cy="232" r="4" stroke-width="1" stroke-dasharray="3,2"/>
    <circle cx="102" cy="232" r="4" stroke-width="1" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost at B (top of loop, 270,90) -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="255" y="76" width="30" height="14" rx="3" stroke-width="1.5" stroke-dasharray="4,3"/>
    <circle cx="261" cy="74" r="4" stroke-width="1" stroke-dasharray="3,2"/>
    <circle cx="279" cy="74" r="4" stroke-width="1" stroke-dasharray="3,2"/>
  </g>
  <!-- Velocity lines at B (trailing behind cart moving leftward at top of loop) -->
  <g opacity="0.3" stroke="var(--color-k)" stroke-width="1.5" stroke-linecap="round">
    <line x1="290" y1="80" x2="300" y2="80"/>
    <line x1="290" y1="84" x2="303" y2="84"/>
    <line x1="290" y1="88" x2="300" y2="88"/>
  </g>
  <!-- Labels -->
  <text x="93" y="258" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">A</text>
  <text x="93" y="270" class="txt-dim" font-size="9" text-anchor="middle">v = 0</text>
  <text x="270" y="68" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">B</text>
  <text x="310" y="78" class="txt-dim" font-size="9">v &gt; 0</text>
  <!-- Animated cart: flatâ†’curve upâ†’enters loop at bottom (270,190)â†’
       goes LEFT up the left side (220,140)â†’over top (270,90)=B
       Path: straight run, curve up to loop bottom, then CCW arc (sweep=0) to top -->
  <g>
    <animateMotion path="M93,224 L180,224 Q220,224 240,204 Q255,191 270,184 A50,50 0 0,0 270,84" dur="5s" rotate="auto" repeatCount="indefinite" keyTimes="0;0.08;0.55;0.82;0.83;1" keyPoints="0;0;1;1;0;0" calcMode="spline" keySplines="0 0 1 1;0 0.6 0.4 1;0 0 1 1;0 0 1 1;0 0 1 1"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="-15" y="-7" width="30" height="14" rx="3" class="fill-obj" stroke-width="1.5"/>
    <circle cx="-9" cy="9" r="4" class="fill-obj" stroke-width="1"/>
    <circle cx="9" cy="9" r="4" class="fill-obj" stroke-width="1"/>
  </g>
</svg>`,

"1d": `<svg viewBox="0 0 520 280" width="520" height="280" xmlns="http://www.w3.org/2000/svg">
  <!-- Ground -->
  <line x1="20" y1="230" x2="500" y2="230" class="stroke" stroke-width="2"/>
  <!-- Spring wall -->
  <rect x="28" y="210" width="8" height="22" class="fill-ground" stroke-width="1"/>
  <!-- Coiled spring (animated compressedâ†’relaxed) â€” same as Problem 1 -->
  <path class="fill-spring" fill="none" stroke-width="2.5" stroke-linecap="round">
    <animate attributeName="d" values="M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 48,222 A6,6 0 0,0 60,222 A6,6 0 0,1 72,222 A6,6 0 0,0 84,222 A6,6 0 0,1 96,222 A6,6 0 0,0 108,222;M36,222 A6,6 0 0,1 48,222 A6,6 0 0,0 60,222 A6,6 0 0,1 72,222 A6,6 0 0,0 84,222 A6,6 0 0,1 96,222 A6,6 0 0,0 108,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222;M36,222 A6,6 0 0,1 44,222 A6,6 0 0,0 52,222 A6,6 0 0,1 60,222 A6,6 0 0,0 68,222 A6,6 0 0,1 76,222 A6,6 0 0,0 84,222" keyTimes="0;0.08;0.22;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
  </path>
  <!-- Track: flat from spring â†’ curves up to meet loop at bottom â€” same as Problem 1 -->
  <path d="M84,230 L180,230 Q220,230 240,210 Q255,197 270,190" class="stroke" stroke-width="2"/>
  <!-- Loop (center 270,140 r=50) â€” same as Problem 1 -->
  <circle cx="270" cy="140" r="50" class="stroke" stroke-width="2"/>
  <!-- Track exit (faded) -->
  <path d="M270,190 Q310,200 340,220 L450,230" class="stroke" stroke-width="2" opacity="0.25"/>
  <!-- Height indicator -->
  <line x1="35" y1="230" x2="35" y2="85" class="stroke dashed" stroke-width="1" opacity="0.2"/>
  <text x="14" y="160" class="txt-dim" font-size="11" text-anchor="middle" transform="rotate(-90,14,160)">height</text>
  <!-- Dashed line showing B height (~2 o'clock position, upper-right of loop at 295,97) -->
  <line x1="295" y1="97" x2="295" y2="230" class="stroke dashed" stroke-width="1" opacity="0.2"/>
  <!-- Ghost at A (next to spring) â€” same as Problem 1 -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="78" y="216" width="30" height="14" rx="3" stroke-width="1.5" stroke-dasharray="4,3"/>
    <circle cx="84" cy="232" r="4" stroke-width="1" stroke-dasharray="3,2"/>
    <circle cx="102" cy="232" r="4" stroke-width="1" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost at B (~2 o'clock on loop, upper-right, 295,97) -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="280" y="90" width="30" height="14" rx="3" stroke-width="1.5" stroke-dasharray="4,3"/>
    <circle cx="286" cy="88" r="4" stroke-width="1" stroke-dasharray="3,2"/>
    <circle cx="304" cy="88" r="4" stroke-width="1" stroke-dasharray="3,2"/>
  </g>
  <!-- Velocity lines at B (trailing behind cart) -->
  <g opacity="0.3" stroke="var(--color-k)" stroke-width="1.5" stroke-linecap="round">
    <line x1="313" y1="92" x2="323" y2="92"/>
    <line x1="313" y1="96" x2="326" y2="96"/>
    <line x1="313" y1="100" x2="323" y2="100"/>
  </g>
  <!-- Labels -->
  <text x="93" y="258" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">A</text>
  <text x="93" y="270" class="txt-dim" font-size="9" text-anchor="middle">v = 0</text>
  <text x="320" y="90" class="txt-label" font-size="15" font-weight="800">B</text>
  <text x="320" y="104" class="txt-dim" font-size="9">v &gt; 0</text>
  <!-- Animated cart: same path as Problem 1, but arc stops at ~2 o'clock (295,97)
       instead of going all the way to the top.
       CCW arc (sweep=0) from bottom (270,184) to (295,97) is less than half circle â†’ large-arc=0 -->
  <g>
    <animateMotion path="M93,224 L180,224 Q220,224 240,204 Q255,191 270,184 A50,50 0 0,0 295,91" dur="5s" rotate="auto" repeatCount="indefinite" keyTimes="0;0.08;0.55;0.82;0.83;1" keyPoints="0;0;1;1;0;0" calcMode="spline" keySplines="0 0 1 1;0 0.6 0.4 1;0 0 1 1;0 0 1 1;0 0 1 1"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="-15" y="-7" width="30" height="14" rx="3" class="fill-obj" stroke-width="1.5"/>
    <circle cx="-9" cy="9" r="4" class="fill-obj" stroke-width="1"/>
    <circle cx="9" cy="9" r="4" class="fill-obj" stroke-width="1"/>
  </g>
</svg>`,

2: `<svg viewBox="0 0 480 250" width="480" height="250" xmlns="http://www.w3.org/2000/svg">
  <!-- y-axis -->
  <line x1="40" y1="210" x2="40" y2="30" class="stroke" stroke-width="1.5"/>
  <polygon points="37,35 40,25 43,35" class="txt" style="fill:var(--text-primary)"/>
  <text x="30" y="22" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Incline -->
  <line x1="40" y1="210" x2="420" y2="80" class="stroke" stroke-width="2.5"/>
  <!-- Ground -->
  <line x1="20" y1="210" x2="60" y2="210" class="stroke" stroke-width="1" opacity="0.5"/>
  <!-- Hatching -->
  <line x1="80" y1="202" x2="72" y2="210" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="140" y1="182" x2="132" y2="190" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="200" y1="163" x2="192" y2="171" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="260" y1="143" x2="252" y2="151" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="320" y1="124" x2="312" y2="132" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="380" y1="104" x2="372" y2="112" class="stroke" stroke-width="1" opacity="0.3"/>
  <!-- Dashed height line at B -->
  <line x1="350" y1="80" x2="350" y2="210" class="stroke dashed" stroke-width="1" opacity="0.2"/>
  <text x="342" y="150" class="txt-dim" font-size="10" text-anchor="end">h</text>
  <!-- Ghost at A -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="55" y="186" width="50" height="20" rx="5" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-18.4,80,196)"/>
    <circle cx="65" cy="210" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
    <circle cx="95" cy="204" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost at B -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="335" y="62" width="50" height="20" rx="5" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-18.4,360,72)"/>
    <circle cx="345" cy="86" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
    <circle cx="375" cy="80" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Labels -->
  <text x="80" y="238" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">A</text>
  <text x="80" y="250" class="txt-dim" font-size="9" text-anchor="middle">y = 0, v &gt; 0</text>
  <text x="360" y="56" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">B</text>
  <text x="370" y="45" class="txt-dim" font-size="9" text-anchor="middle">y &gt; 0, v = 0</text>
  <!-- Animated car: follows slope path with deceleration -->
  <g>
    <animateMotion path="M80,196 L360,72" dur="5s" repeatCount="indefinite" keyTimes="0;0.1;0.55;0.82;0.83;1" keyPoints="0;0;1;1;0;0" calcMode="spline" keySplines="0 0 1 1;0.3 0 0.8 1;0 0 1 1;0 0 1 1;0 0 1 1" rotate="auto"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="-25" y="-14" width="50" height="20" rx="5" class="fill-obj" stroke-width="1.5"/>
    <circle cx="-15" cy="8" r="6" class="fill-obj" stroke-width="1.5"/>
    <circle cx="15" cy="8" r="6" class="fill-obj" stroke-width="1.5"/>
  </g>
</svg>`,

3: `<svg viewBox="0 0 480 260" width="480" height="260" xmlns="http://www.w3.org/2000/svg">
  <!-- y-axis -->
  <line x1="40" y1="210" x2="40" y2="30" class="stroke" stroke-width="1.5"/>
  <polygon points="37,35 40,25 43,35" class="txt" style="fill:var(--text-primary)"/>
  <text x="30" y="22" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Incline -->
  <line x1="40" y1="210" x2="420" y2="80" class="stroke" stroke-width="2.5"/>
  <!-- Hatching -->
  <line x1="120" y1="189" x2="112" y2="197" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="200" y1="163" x2="192" y2="171" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="280" y1="137" x2="272" y2="145" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="360" y1="111" x2="352" y2="119" class="stroke" stroke-width="1" opacity="0.3"/>
  <!-- Ghost car at A -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="72" y="184" width="50" height="20" rx="5" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-18.4,97,194)"/>
    <circle cx="82" cy="208" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
    <circle cx="112" cy="202" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost car at B -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="335" y="62" width="50" height="20" rx="5" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-18.4,360,72)"/>
    <circle cx="345" cy="86" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
    <circle cx="375" cy="80" r="6" stroke-width="1.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Labels -->
  <text x="90" y="238" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">A</text>
  <text x="90" y="250" class="txt-dim" font-size="9" text-anchor="middle">h = 0, v = 0</text>
  <text x="360" y="53" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">B</text>
  <text x="370" y="42" class="txt-dim" font-size="9" text-anchor="middle">h &gt; 0, v = 0</text>
  <!-- Animated person + car group: follows slope with acceleration from rest -->
  <g>
    <animateMotion path="M97,194 L360,72" dur="5s" repeatCount="indefinite" keyTimes="0;0.1;0.55;0.82;0.83;1" keyPoints="0;0;1;1;0;0" calcMode="spline" keySplines="0 0 1 1;0 0.2 0.6 1;0 0 1 1;0 0 1 1;0 0 1 1" rotate="auto"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <!-- Person (stick figure) pushing â€” positioned left of car -->
    <circle cx="-40" cy="-22" r="7" class="stroke" stroke-width="1.5"/>
    <line x1="-40" y1="-15" x2="-40" y2="2" class="stroke" stroke-width="1.5"/>
    <line x1="-40" y1="2" x2="-50" y2="14" class="stroke" stroke-width="1.5"/>
    <line x1="-40" y1="2" x2="-30" y2="10" class="stroke" stroke-width="1.5"/>
    <line x1="-40" y1="-6" x2="-24" y2="-9" class="stroke" stroke-width="1.5"/>
    <line x1="-40" y1="-6" x2="-50" y2="0" class="stroke" stroke-width="1.5"/>
    <!-- Push arrow -->
    <line x1="-28" y1="-9" x2="-18" y2="-11" class="arrow-v" stroke-width="2.5"/>
    <!-- Car body -->
    <rect x="-25" y="-14" width="50" height="20" rx="5" class="fill-obj" stroke-width="1.5"/>
    <circle cx="-15" cy="8" r="6" class="fill-obj" stroke-width="1.5"/>
    <circle cx="15" cy="8" r="6" class="fill-obj" stroke-width="1.5"/>
    <!-- Brake marks -->
    <line x1="-19" y1="6" x2="-11" y2="10" class="stroke" stroke-width="2" style="stroke:var(--fx-red)"/>
    <line x1="11" y1="6" x2="19" y2="10" class="stroke" stroke-width="2" style="stroke:var(--fx-red)"/>
  </g>
</svg>`,

4: `<svg viewBox="0 0 320 300" width="320" height="300" xmlns="http://www.w3.org/2000/svg">
  <!-- y-axis -->
  <line x1="50" y1="260" x2="50" y2="20" class="stroke" stroke-width="1.5"/>
  <polygon points="47,25 50,15 53,25" class="txt" style="fill:var(--text-primary)"/>
  <text x="40" y="14" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Ground / zero line -->
  <line x1="30" y1="230" x2="260" y2="230" class="stroke" stroke-width="1" opacity="0.4"/>
  <!-- Spring base plate -->
  <rect x="115" y="256" width="50" height="6" rx="1" class="fill-ground" stroke-width="1"/>
  <!-- Coiled spring (animated compressedâ†’relaxed, vertical orientation) -->
  <path class="fill-spring" fill="none" stroke-width="2.5" stroke-linecap="round">
    <animate attributeName="d" values="M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,3 0 0,1 140,250 A8,3 0 0,0 140,244 A8,3 0 0,1 140,238 A8,3 0 0,0 140,232;M140,256 A8,3 0 0,1 140,250 A8,3 0 0,0 140,244 A8,3 0 0,1 140,238 A8,3 0 0,0 140,232;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224" keyTimes="0;0.08;0.20;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
  </path>
  <!-- Dashed trail A to B -->
  <line x1="140" y1="210" x2="140" y2="95" class="stroke dashed" stroke-width="1" opacity="0.15"/>
  <!-- Ghost at A (sitting on spring) -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="113" y="200" width="54" height="24" rx="1" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="140" y1="200" x2="140" y2="212" stroke-width="0.5" stroke-dasharray="3,2"/>
    <line x1="113" y1="212" x2="167" y2="212" stroke-width="0.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost at B -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="113" y="65" width="54" height="24" rx="1" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="140" y1="65" x2="140" y2="77" stroke-width="0.5" stroke-dasharray="3,2"/>
    <line x1="113" y1="77" x2="167" y2="77" stroke-width="0.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Labels -->
  <text x="178" y="218" class="txt-label" font-size="15" font-weight="800">A</text>
  <text x="196" y="230" class="txt-dim" font-size="9">h = 0, v = 0</text>
  <text x="178" y="82" class="txt-label" font-size="15" font-weight="800">B</text>
  <text x="196" y="75" class="txt-dim" font-size="9">h &gt; 0, v &gt; 0</text>
  <!-- Velocity arrow at B (static indicator) -->
  <g opacity="0.35">
    <line x1="140" y1="60" x2="140" y2="42" class="arrow-v" stroke-width="2"/>
    <polygon points="135,46 140,36 145,46" class="arrow-v"/>
  </g>
  <!-- Animated bricks: fast launch from spring, decelerates going up -->
  <g>
    <animateTransform attributeName="transform" type="translate" values="0 0;0 0;0 -135;0 -135;0 0;0 0" keyTimes="0;0.08;0.55;0.82;0.83;1" dur="5s" repeatCount="indefinite" calcMode="spline" keySplines="0 0 1 1;0 0.8 0.5 1;0 0 1 1;0 0 1 1;0 0 1 1"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="113" y="200" width="54" height="24" rx="1" class="fill-obj" stroke-width="1.5"/>
    <line x1="140" y1="200" x2="140" y2="212" class="stroke" stroke-width="0.5" opacity="0.4"/>
    <line x1="127" y1="212" x2="127" y2="224" class="stroke" stroke-width="0.5" opacity="0.4"/>
    <line x1="153" y1="212" x2="153" y2="224" class="stroke" stroke-width="0.5" opacity="0.4"/>
    <line x1="113" y1="212" x2="167" y2="212" class="stroke" stroke-width="0.5" opacity="0.4"/>
  </g>
</svg>`,

"4c": `<svg viewBox="0 0 320 300" width="320" height="300" xmlns="http://www.w3.org/2000/svg">
  <!-- y-axis -->
  <line x1="50" y1="260" x2="50" y2="20" class="stroke" stroke-width="1.5"/>
  <polygon points="47,25 50,15 53,25" class="txt" style="fill:var(--text-primary)"/>
  <text x="40" y="14" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Zero line at B's level -->
  <line x1="30" y1="100" x2="260" y2="100" class="stroke" stroke-width="1.5" opacity="0.5"/>
  <text x="268" y="104" class="txt-dim" font-size="10">y = 0</text>
  <!-- Ground -->
  <line x1="95" y1="230" x2="185" y2="230" class="stroke" stroke-width="1" opacity="0.3"/>
  <!-- Spring base plate -->
  <rect x="115" y="256" width="50" height="6" rx="1" class="fill-ground" stroke-width="1"/>
  <!-- Coiled spring (animated compressedâ†’relaxed) -->
  <path class="fill-spring" fill="none" stroke-width="2.5" stroke-linecap="round">
    <animate attributeName="d" values="M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,3 0 0,1 140,250 A8,3 0 0,0 140,244 A8,3 0 0,1 140,238 A8,3 0 0,0 140,232;M140,256 A8,3 0 0,1 140,250 A8,3 0 0,0 140,244 A8,3 0 0,1 140,238 A8,3 0 0,0 140,232;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224;M140,256 A8,4 0 0,1 140,248 A8,4 0 0,0 140,240 A8,4 0 0,1 140,232 A8,4 0 0,0 140,224" keyTimes="0;0.08;0.20;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
  </path>
  <!-- Dashed trail -->
  <line x1="140" y1="210" x2="140" y2="105" class="stroke dashed" stroke-width="1" opacity="0.15"/>
  <!-- Ghost at A -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="113" y="210" width="54" height="24" rx="1" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="140" y1="210" x2="140" y2="222" stroke-width="0.5" stroke-dasharray="3,2"/>
    <line x1="113" y1="222" x2="167" y2="222" stroke-width="0.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Ghost at B (at zero line) -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="113" y="76" width="54" height="24" rx="1" stroke-width="1.5" stroke-dasharray="4,3"/>
    <line x1="140" y1="76" x2="140" y2="88" stroke-width="0.5" stroke-dasharray="3,2"/>
    <line x1="113" y1="88" x2="167" y2="88" stroke-width="0.5" stroke-dasharray="3,2"/>
  </g>
  <!-- Labels -->
  <text x="178" y="228" class="txt-label" font-size="15" font-weight="800">A</text>
  <text x="196" y="240" class="txt-dim" font-size="9">h &lt; 0</text>
  <text x="178" y="93" class="txt-label" font-size="15" font-weight="800">B</text>
  <text x="196" y="86" class="txt-dim" font-size="9">h = 0</text>
  <!-- Velocity arrow at B -->
  <g opacity="0.35">
    <line x1="140" y1="71" x2="140" y2="53" class="arrow-v" stroke-width="2"/>
    <polygon points="135,57 140,47 145,57" class="arrow-v"/>
  </g>
  <!-- Animated bricks -->
  <g>
    <animateTransform attributeName="transform" type="translate" values="0 0;0 0;0 -134;0 -134;0 0;0 0" keyTimes="0;0.08;0.55;0.82;0.83;1" dur="5s" repeatCount="indefinite" calcMode="spline" keySplines="0 0 1 1;0 0.8 0.5 1;0 0 1 1;0 0 1 1;0 0 1 1"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="113" y="210" width="54" height="24" rx="1" class="fill-obj" stroke-width="1.5"/>
    <line x1="140" y1="210" x2="140" y2="222" class="stroke" stroke-width="0.5" opacity="0.4"/>
    <line x1="113" y1="222" x2="167" y2="222" class="stroke" stroke-width="0.5" opacity="0.4"/>
  </g>
</svg>`,

5: `<svg viewBox="0 0 480 270" width="480" height="270" xmlns="http://www.w3.org/2000/svg">
  <!-- y-axis -->
  <line x1="50" y1="230" x2="50" y2="30" class="stroke" stroke-width="1.5"/>
  <polygon points="47,35 50,25 53,35" class="txt" style="fill:var(--text-primary)"/>
  <text x="40" y="22" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Ground -->
  <line x1="30" y1="220" x2="100" y2="220" class="stroke" stroke-width="1" opacity="0.4"/>
  <!-- Incline -->
  <line x1="55" y1="220" x2="420" y2="70" class="stroke" stroke-width="2.5"/>
  <!-- Hatching -->
  <line x1="120" y1="198" x2="112" y2="206" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="180" y1="173" x2="172" y2="181" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="240" y1="148" x2="232" y2="156" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="300" y1="123" x2="292" y2="131" class="stroke" stroke-width="1" opacity="0.3"/>
  <line x1="360" y1="98" x2="352" y2="106" class="stroke" stroke-width="1" opacity="0.3"/>
  <!-- Spring wall -->
  <rect x="55" y="205" width="10" height="30" class="fill-ground" stroke-width="1"/>
  <!-- Coiled spring (animated compressedâ†’relaxed, rotated to slope angle) -->
  <g transform="rotate(-22,65,220)">
    <path class="fill-spring" fill="none" stroke-width="2.5" stroke-linecap="round">
      <animate attributeName="d" values="M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 89,220 A5,5 0 0,0 97,220;M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 89,220 A5,5 0 0,0 97,220;M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 86,220;M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 86,220;M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 89,220 A5,5 0 0,0 97,220;M65,220 A5,5 0 0,1 73,220 A5,5 0 0,0 81,220 A5,5 0 0,1 89,220 A5,5 0 0,0 97,220" keyTimes="0;0.08;0.22;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </path>
  </g>
  <!-- Height dashed line -->
  <line x1="270" y1="130" x2="270" y2="220" class="stroke dashed" stroke-width="1" opacity="0.2"/>
  <!-- Ghost at A -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="88" y="195" width="40" height="22" rx="2" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-22,108,206)"/>
  </g>
  <!-- Ghost at B -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)">
    <rect x="260" y="115" width="40" height="22" rx="2" stroke-width="1.5" stroke-dasharray="4,3" transform="rotate(-22,280,126)"/>
  </g>
  <!-- Labels -->
  <text x="100" y="250" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">A</text>
  <text x="100" y="262" class="txt-dim" font-size="9" text-anchor="middle">h = 0, v = 0</text>
  <text x="280" y="108" class="txt-label" font-size="15" text-anchor="middle" font-weight="800">B</text>
  <text x="295" y="100" class="txt-dim" font-size="9" text-anchor="middle">h &gt; 0, v &gt; 0</text>
  <!-- Velocity arrow at B -->
  <g opacity="0.35">
    <line x1="300" y1="120" x2="325" y2="110" class="arrow-v" stroke-width="2"/>
    <polygon points="322,104 332,107 325,114" class="arrow-v"/>
  </g>
  <!-- Animated crate: follows slope with spring-launch acceleration -->
  <g>
    <animateMotion path="M108,206 L280,126" dur="5s" repeatCount="indefinite" keyTimes="0;0.08;0.55;0.82;0.83;1" keyPoints="0;0;1;1;0;0" calcMode="spline" keySplines="0 0 1 1;0 0.7 0.4 1;0 0 1 1;0 0 1 1;0 0 1 1" rotate="auto"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <rect x="-20" y="-11" width="40" height="22" rx="2" class="fill-obj" stroke-width="1.5"/>
  </g>
</svg>`,

6: `<svg viewBox="0 0 360 320" width="360" height="320" xmlns="http://www.w3.org/2000/svg">
  <!-- Platform -->
  <rect x="30" y="40" width="80" height="12" class="fill-ground" stroke-width="1.5"/>
  <rect x="30" y="52" width="12" height="250" class="fill-ground" stroke-width="1.5"/>
  <!-- y-axis -->
  <line x1="18" y1="300" x2="18" y2="20" class="stroke" stroke-width="1.5"/>
  <polygon points="15,25 18,15 21,25" class="txt" style="fill:var(--text-primary)"/>
  <text x="11" y="14" class="txt" font-size="13" font-weight="700">y</text>
  <!-- Ground / zero line -->
  <line x1="10" y1="300" x2="300" y2="300" class="stroke" stroke-width="1" opacity="0.4"/>
  <text x="305" y="304" class="txt-dim" font-size="9">0</text>
  <!-- Height indicators -->
  <line x1="75" y1="45" x2="75" y2="300" class="stroke dashed" stroke-width="1" opacity="0.15"/>
  <line x1="145" y1="232" x2="145" y2="300" class="stroke dashed" stroke-width="1" opacity="0.15"/>
  <!-- Animated bungee cord â€” platform (90,52) to ankle.
       All keyframes use identical path structure (M + 3 Q commands) so SVG can interpolate smoothly.
       Ankle world pos: starts (90,48), ends (120,232). -->
  <path class="cord" stroke-width="2.5">
    <animate attributeName="d" values="M90,52 Q90,53 90,54 Q90,55 90,56 Q90,57 90,58;M90,52 Q90,53 90,54 Q90,55 90,56 Q90,57 90,58;M90,52 Q92,70 95,100 Q100,140 108,175 Q114,205 120,232;M90,52 Q92,70 95,100 Q100,140 108,175 Q114,205 120,232;M90,52 Q90,53 90,54 Q90,55 90,56 Q90,57 90,58;M90,52 Q90,53 90,54 Q90,55 90,56 Q90,57 90,58" keyTimes="0;0.1;0.55;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
  </path>
  <!-- Ghost jumper at A â€” standing on platform edge, upright -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)" stroke-dasharray="3,2">
    <!-- Head -->
    <circle cx="90" cy="8" r="7" stroke-width="1.5"/>
    <!-- Body -->
    <line x1="90" y1="15" x2="90" y2="34" stroke-width="1.5"/>
    <!-- Arms out -->
    <line x1="90" y1="20" x2="78" y2="26" stroke-width="1.5"/>
    <line x1="90" y1="20" x2="102" y2="26" stroke-width="1.5"/>
    <!-- Legs â€” one leg has cord attachment point -->
    <line x1="90" y1="34" x2="83" y2="48" stroke-width="1.5"/>
    <line x1="90" y1="34" x2="97" y2="48" stroke-width="1.5"/>
    <!-- Cord attachment mark on left ankle -->
    <circle cx="83" y="48" r="2" stroke-width="1"/>
  </g>
  <!-- Ghost jumper at B â€” upside down, hanging by ankle -->
  <g opacity="0.25" fill="none" stroke="var(--text-primary)" stroke-dasharray="3,2">
    <!-- Ankle (top, where cord attaches) -->
    <circle cx="120" cy="232" r="2" stroke-width="1"/>
    <!-- Leg up to hip (upside down) -->
    <line x1="120" y1="232" x2="120" y2="244" stroke-width="1.5"/>
    <!-- Other leg dangling -->
    <line x1="120" y1="244" x2="126" y2="232" stroke-width="1.5"/>
    <!-- Body (torso hangs down) -->
    <line x1="120" y1="244" x2="120" y2="262" stroke-width="1.5"/>
    <!-- Arms hanging down -->
    <line x1="120" y1="256" x2="112" y2="268" stroke-width="1.5"/>
    <line x1="120" y1="256" x2="128" y2="268" stroke-width="1.5"/>
    <!-- Head at bottom -->
    <circle cx="120" cy="270" r="7" stroke-width="1.5"/>
  </g>
  <!-- Labels -->
  <text x="118" y="8" class="txt-label" font-size="15" font-weight="800">A</text>
  <text x="118" y="-2" class="txt-dim" font-size="9">h &gt; 0, v = 0</text>
  <text x="150" y="250" class="txt-label" font-size="15" font-weight="800">B</text>
  <text x="150" y="264" class="txt-dim" font-size="9">h &gt; 0, v = 0</text>
  <!-- Animated jumper â€” transitions from upright standing to upside-down hanging -->
  <g>
    <animateTransform attributeName="transform" type="translate" values="0 0;0 0;30 184;30 184;0 0;0 0" keyTimes="0;0.1;0.55;0.82;0.83;1" dur="5s" repeatCount="indefinite" calcMode="spline" keySplines="0 0 1 1;0.42 0 1 0.6;0 0 1 1;0 0 1 1;0 0 1 1"/>
    <animate attributeName="opacity" values="1;1;0;0;1;1" keyTimes="0;0.80;0.82;0.84;0.86;1" dur="5s" repeatCount="indefinite"/>
    <!-- Ankle / cord attachment â€” stays at top when flipped -->
    <circle cx="90" cy="48" r="2" class="stroke" stroke-width="1.5" style="stroke:var(--fx-purple)"/>
    <!-- Leg from ankle to hip: animate from upright to inverted -->
    <line class="stroke" stroke-width="2">
      <animate attributeName="x1" values="83;83;90;90;83;83" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y1" values="48;48;48;48;48;48" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="x2" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y2" values="34;34;60;60;34;34" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </line>
    <!-- Other leg -->
    <line class="stroke" stroke-width="2">
      <animate attributeName="x1" values="97;97;96;96;97;97" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y1" values="48;48;48;48;48;48" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="x2" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y2" values="34;34;60;60;34;34" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </line>
    <!-- Body/torso -->
    <line class="stroke" stroke-width="2">
      <animate attributeName="x1" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y1" values="34;34;60;60;34;34" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="x2" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y2" values="15;15;78;78;15;15" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </line>
    <!-- Left arm -->
    <line class="stroke" stroke-width="2">
      <animate attributeName="x1" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y1" values="20;20;72;72;20;20" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="x2" values="78;78;82;82;78;78" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y2" values="26;26;84;84;26;26" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </line>
    <!-- Right arm -->
    <line class="stroke" stroke-width="2">
      <animate attributeName="x1" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y1" values="20;20;72;72;20;20" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="x2" values="102;102;98;98;102;102" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="y2" values="26;26;84;84;26;26" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </line>
    <!-- Head: animate from top to bottom -->
    <circle r="7" class="stroke" stroke-width="2">
      <animate attributeName="cx" values="90;90;90;90;90;90" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
      <animate attributeName="cy" values="8;8;85;85;8;8" keyTimes="0;0.1;0.35;0.82;0.84;1" dur="5s" repeatCount="indefinite"/>
    </circle>
  </g>
</svg>`

};

// Sub-part specific diagrams (only where different from the main problem diagram)
const PART_DIAGRAMS = {};


// â”€â”€â”€ PROBLEM DATA â”€â”€â”€
const PROBLEMS = [
{
    id: 1,
    title: "Problem 1: Spring Launches Roller Coaster",
    scenario: "A spring launches a roller coaster cart from rest into a vertical loop. Position A is at the bottom (spring compressed, cart at rest). Position B is at the top of the loop (cart moving).",
    parts: [
        { id:"1a", label:"(a)", desc:"The track is frictionless.", system:"cart + Earth + track + spring",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub>" },
        { id:"1b", label:"(b)", desc:"The system does NOT include the spring.", system:"cart + Earth + track (no spring)",
          answer:{ iUg:"zero", iUs:"zero", iK:"zero", wext:"pos", fUg:"pos", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, eq:"W<sub>ext</sub> = U<sub>g,f</sub> + K<sub>f</sub>",
          hint:"Since the spring is outside the system, it does positive external work on the system." },
        { id:"1c", label:"(c)", desc:"Same system as (a), but the track is no longer frictionless.", system:"cart + Earth + track + spring",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"pos" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub> + Q" },
        { id:"1d", label:"(d)", desc:"Same as (a), but the final position is lower on the track (not at the top of the loop). Scale bars consistently with (a).", system:"cart + Earth + track + spring",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub>",
          hint:"Since the cart is lower than in (a), U<sub>g,f</sub> should be smaller and K<sub>f</sub> should be larger than your answer to (a)." }
    ]
},
{
    id: 2,
    title: "Problem 2: Car Rolls Up a Hill",
    scenario: "A moving car rolls up a hill until it stops. Position A is at the bottom (car moving, y<sub>A</sub>=0, v<sub>A</sub>>0). Position B is at the top (car stopped, y<sub>B</sub>>0, v<sub>B</sub>=0). The engine is off and the car is in neutral.",
    parts: [
        { id:"2a", label:"(a)", desc:"No friction.", system:"car + road + Earth",
          answer:{ iUg:"zero", iUs:"zero", iK:"pos", wext:"zero", fUg:"pos", fUs:"zero", fK:"zero", fQ:"zero" },
          conserve:true, eq:"K<sub>i</sub> = U<sub>g,f</sub>" },
        { id:"2b", label:"(b)", desc:"Same system, now with friction.", system:"car + road + Earth",
          answer:{ iUg:"zero", iUs:"zero", iK:"pos", wext:"zero", fUg:"pos", fUs:"zero", fK:"zero", fQ:"pos" },
          conserve:true, eq:"K<sub>i</sub> = U<sub>g,f</sub> + Q" }
    ]
},
{
    id: 3,
    title: "Problem 3: Person Pushes Car Up Hill",
    scenario: "A person pushes a car, with the parking brake on, up a hill. Position A is at the bottom (h<sub>A</sub>=0, v<sub>A</sub>=0). Position B is at the top (h<sub>B</sub>>0, v<sub>B</sub>=0).",
    parts: [
        { id:"3a", label:"(a)", desc:"The person is NOT part of the system.", system:"car + road + Earth (no person)",
          answer:{ iUg:"zero", iUs:"zero", iK:"zero", wext:"pos", fUg:"pos", fUs:"zero", fK:"zero", fQ:"pos" },
          conserve:true, eq:"W<sub>ext</sub> = U<sub>g,f</sub> + Q",
          hint:"The person does positive work on the system. The parking brake creates friction (thermal energy)." },
        { id:"3b", label:"(b)", desc:"The person IS part of the system.", system:"car + road + Earth + person",
          initialBars:['iUg','iUs','iK','iEchem'],
          answer:{ iUg:"zero", iUs:"zero", iK:"zero", iEchem:"pos", wext:"zero", fUg:"pos", fUs:"zero", fK:"zero", fQ:"pos" },
          conserve:true, eq:"E<sub>chem,i</sub> = U<sub>g,f</sub> + Q",
          hint:"With the person in the system, their chemical (food) energy is the source. There is no external work since everything is inside the system." }
    ]
},
{
    id: 4,
    title: "Problem 4: Bricks Launched by Spring",
    scenario: "A load of bricks rests on a tightly coiled spring and is launched into the air. Position A is at the bottom (spring compressed, h<sub>A</sub>=0, v<sub>A</sub>=0). Position B is in the air above (h<sub>B</sub>>0, v<sub>B</sub>>0).",
    parts: [
        { id:"4a", label:"(a)", desc:"No friction.", system:"spring + bricks + Earth",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub>" },
        { id:"4b", label:"(b)", desc:"Now with friction.", system:"spring + bricks + Earth",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"pos" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub> + Q" },
        { id:"4c", label:"(c)", desc:"Same as (a) but now height 0 is at position B. This means h<sub>A</sub> < 0. No friction.", system:"spring + bricks + Earth",
          answer:{ iUg:"neg", iUs:"pos", iK:"zero", wext:"zero", fUg:"zero", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, allowNeg:true, eq:"U<sub>s,i</sub> + U<sub>g,i</sub> = K<sub>f</sub> &nbsp;(where U<sub>g,i</sub> &lt; 0)",
          hint:"Since h<sub>A</sub> < 0, the initial U<sub>g</sub> is negative! Click below the zero line to make a negative bar." },
        { id:"4d", label:"(d)", desc:"Same as (a) but for a system that does NOT include Earth. No friction.", system:"spring + bricks (no Earth)",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"neg", fUg:"zero", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, allowNeg:true, eq:"U<sub>s,i</sub> + W<sub>gravity</sub> = K<sub>f</sub>",
          hint:"Without Earth in the system, there is no U<sub>g</sub>. Gravity is an external force that does negative work (force is down, displacement is up)." }
    ]
},
{
    id: 5,
    title: "Problem 5: Crate Propelled Up Hill by Spring",
    scenario: "A crate is propelled up a hill by a tightly coiled spring. Position A is at the bottom (spring compressed, h<sub>A</sub>=0, v<sub>A</sub>=0). Position B is partway up the hill (h<sub>B</sub>>0, v<sub>B</sub>>0).",
    parts: [
        { id:"5a", label:"(a)", desc:"No friction.", system:"spring + hill + crate + Earth",
          answer:{ iUg:"zero", iUs:"pos", iK:"zero", wext:"zero", fUg:"pos", fUs:"zero", fK:"pos", fQ:"zero" },
          conserve:true, eq:"U<sub>s,i</sub> = U<sub>g,f</sub> + K<sub>f</sub>" },
        { id:"5b", label:"(b)", desc:"System does NOT include the spring. With friction.", system:"hill + crate + Earth (no spring)",
          answer:{ iUg:"zero", iUs:"zero", iK:"zero", wext:"pos", fUg:"pos", fUs:"zero", fK:"pos", fQ:"pos" },
          conserve:true, eq:"W<sub>spring</sub> = U<sub>g,f</sub> + K<sub>f</sub> + Q",
          hint:"The spring does positive external work. Friction converts some energy to thermal." }
    ]
},
{
    id: 6,
    title: "Problem 6: Bungee Jumper",
    scenario: "A bungee jumper falls off a platform and reaches the limit of stretch of the cord. Position A is at the top (h<sub>A</sub>>0, v<sub>A</sub>=0). Position B is at the bottom with the cord fully stretched (h<sub>B</sub>>0, v<sub>B</sub>=0).",
    parts: [
        { id:"6a", label:"(a)", desc:"Frictionless.", system:"jumper + Earth + cord",
          answer:{ iUg:"pos", iUs:"zero", iK:"zero", wext:"zero", fUg:"pos", fUs:"pos", fK:"zero", fQ:"zero" },
          conserve:true, eq:"U<sub>g,i</sub> = U<sub>g,f</sub> + U<sub>s,f</sub>",
          hint:"The jumper starts high (large U<sub>g</sub>) and ends lower (small U<sub>g</sub>) with the cord stretched (U<sub>s</sub>). At the limit of stretch, v=0 so K=0. Make sure U<sub>g,i</sub> > U<sub>g,f</sub>." },
        { id:"6b", label:"(b)", desc:"The cord is NOT part of the system.", system:"jumper + Earth (no cord)",
          answer:{ iUg:"pos", iUs:"zero", iK:"zero", wext:"neg", fUg:"pos", fUs:"zero", fK:"zero", fQ:"zero" },
          conserve:true, allowNeg:true, eq:"U<sub>g,i</sub> + W<sub>cord</sub> = U<sub>g,f</sub>",
          hint:"The cord does negative work on the jumper (upward force, downward displacement during stretching). Without the cord in the system, there is no U<sub>s</sub>." }
    ]
}
];

// â”€â”€â”€ STATE â”€â”€â”€
const state = {}; // state[partId] = { iUg:0, iUs:0, iK:0, wext:0, fUg:0, fUs:0, fK:0, fQ:0 }
const completed = new Set();
const DEFAULT_BAR_KEYS = ['iUg','iUs','iK','wext','fUg','fUs','fK','fQ'];
const ALL_BAR_KEYS = ['iUg','iUs','iK','iEchem','wext','fUg','fUs','fK','fQ'];
const MAX_POS = 8, MAX_NEG = -3;
const BAR_COLORS = { iUg:'ug', iUs:'us', iK:'k', iEchem:'echem', wext:'wext', fUg:'ug', fUs:'us', fK:'k', fQ:'q' };
const BAR_LABELS = { iUg:'U<sub>g</sub>', iUs:'U<sub>s</sub>', iK:'K', iEchem:'E<sub>chem</sub>', wext:'W<sub>ext</sub>', fUg:'U<sub>g</sub>', fUs:'U<sub>s</sub>', fK:'K', fQ:'Q' };

function initState(partId) {
    if (!state[partId]) state[partId] = { iUg:0, iUs:0, iK:0, iEchem:0, wext:0, fUg:0, fUs:0, fK:0, fQ:0 };
}

// â”€â”€â”€ RENDERING â”€â”€â”€
function renderAll() {
    const container = document.getElementById('problems');
    container.innerHTML = '';
    PROBLEMS.forEach(prob => {
        const card = document.createElement('div');
        card.className = 'problem-card';
        const completedParts = prob.parts.filter(p => completed.has(p.id)).length;
        const totalParts = prob.parts.length;
        const statusClass = completedParts === totalParts ? 'complete' : 'incomplete';
        const statusText = completedParts === totalParts ? 'âœ“ Complete' : `${completedParts}/${totalParts}`;
        const diagramHTML = DIAGRAMS[prob.id] ? `<div class="diagram-container">${DIAGRAMS[prob.id]}</div>` : '';
        card.innerHTML = `
            <div class="problem-header">
                <h2>${prob.title}</h2>
                <span class="problem-status ${statusClass}" id="status-${prob.id}">${statusText}</span>
            </div>
            <div class="problem-scenario">${prob.scenario}${diagramHTML}</div>
        `;
        prob.parts.forEach(part => {
            initState(part.id);
            const partDiagramHTML = DIAGRAMS[part.id] ? `<div class="part-diagram">${DIAGRAMS[part.id]}</div>` : '';
            const partDiv = document.createElement('div');
            partDiv.className = 'part-container';
            partDiv.id = `part-${part.id}`;
            partDiv.innerHTML = `
                <div class="part-label">${part.label}</div>
                <div class="part-desc">${part.desc}</div>
                ${partDiagramHTML}
                <div class="system-def">System: ${part.system}</div>
                ${renderBarChart(part)}
                <div class="part-actions">
                    <button class="check-btn" onclick="checkAnswer('${part.id}')">Check Answer</button>
                    <button class="reset-btn" onclick="resetPart('${part.id}')">Reset</button>
                </div>
                <div class="feedback" id="fb-${part.id}"></div>
                <div class="equation-display" id="eq-${part.id}"></div>
            `;
            card.appendChild(partDiv);
        });
        container.appendChild(card);
    });
    // Sandbox
    renderSandbox();
    updateProgress();
}

function getPartBarLayout(part) {
    return {
        initialBars: part.initialBars || ['iUg','iUs','iK'],
        workBars: part.workBars || ['wext'],
        finalBars: part.finalBars || ['fUg','fUs','fK','fQ']
    };
}

function getPartAllKeys(part) {
    const layout = getPartBarLayout(part);
    return [...layout.initialBars, ...layout.workBars, ...layout.finalBars];
}

function renderBarChart(part) {
    const allowNeg = part.allowNeg || false;
    const minVal = allowNeg ? MAX_NEG : 0;
    const layout = getPartBarLayout(part);

    function renderSection(label, keys) {
        const cols = keys.map(k => renderColumn(part.id, k, minVal)).join('');
        return `<div class="chart-section"><div class="section-label">${label}</div><div class="bars-row">${cols}</div></div>`;
    }

    return `<div class="chart-wrapper">
        ${renderSection('Initial Energy', layout.initialBars)}
        <div class="operator">+</div>
        ${renderSection('Work', layout.workBars)}
        <div class="operator">=</div>
        ${renderSection('Final Energy', layout.finalBars)}
    </div>`;
}

function renderColumn(partId, key, minVal) {
    const val = state[partId][key];
    const colorClass = `filled-${BAR_COLORS[key]}`;

    // Positive cells (top to bottom: MAX_POS down to 1)
    let posCells = '';
    for (let h = MAX_POS; h >= 1; h--) {
        const filled = (val > 0 && h <= val) ? colorClass : '';
        posCells += `<div class="cell ${filled}" data-part="${partId}" data-key="${key}" data-h="${h}" onclick="clickCell('${partId}','${key}',${h})"></div>`;
    }

    // Negative cells (-1 down to minVal)
    let negSection = '';
    if (minVal < 0) {
        let negCells = '';
        for (let h = -1; h >= minVal; h--) {
            const filled = (val < 0 && h >= val) ? colorClass : '';
            negCells += `<div class="cell neg-zone ${filled}" data-part="${partId}" data-key="${key}" data-h="${h}" onclick="clickCell('${partId}','${key}',${h})"></div>`;
        }
        negSection = `<div class="cells-container" style="border-top:none;border-radius:0 0 3px 3px">${negCells}</div>`;
    }

    const displayVal = val !== 0 ? val : '';
    return `<div class="bar-col">
        <div class="cells-container">${posCells}</div>
        <div class="zero-line"></div>
        ${negSection}
        <div class="bar-label">${BAR_LABELS[key]}</div>
        <div class="chart-value">${displayVal}</div>
    </div>`;
}

// (Column rendering handled by renderColumn above)

// Rebuild a single column's visual without re-rendering everything
function updateColumn(partId, key) {
    const part = findPart(partId);
    const partContainer = document.getElementById(`part-${partId}`) || document.getElementById(partId);
    if (!partContainer) return;
    // Find all cells for this key and update
    const cells = partContainer.querySelectorAll(`[data-part="${partId}"][data-key="${key}"]`);
    const val = state[partId][key];
    const colorClass = `filled-${BAR_COLORS[key]}`;
    cells.forEach(cell => {
        const h = parseInt(cell.dataset.h);
        cell.classList.remove('filled-ug','filled-us','filled-k','filled-echem','filled-wext','filled-q');
        if (h > 0 && val > 0 && h <= val) cell.classList.add(colorClass);
        else if (h < 0 && val < 0 && h >= val) cell.classList.add(colorClass);
    });
    // Update value display â€” use part-specific bar order
    const allCols = partContainer.querySelectorAll('.bar-col');
    const barOrder = part ? getPartAllKeys(part) : DEFAULT_BAR_KEYS;
    const idx = barOrder.indexOf(key);
    if (idx >= 0 && allCols[idx]) {
        const valDisplay = allCols[idx].querySelector('.chart-value');
        if (valDisplay) valDisplay.textContent = val !== 0 ? val : '';
    }
}

// â”€â”€â”€ INTERACTION â”€â”€â”€
function clickCell(partId, key, h) {
    initState(partId);
    const current = state[partId][key];
    if (current === h) {
        state[partId][key] = 0; // Toggle off
    } else {
        state[partId][key] = h;
    }
    updateColumn(partId, key);
    // Clear feedback when user changes bars
    const fb = document.getElementById(`fb-${partId}`);
    if (fb) { fb.className = 'feedback'; fb.innerHTML = ''; }
    const eq = document.getElementById(`eq-${partId}`);
    if (eq) { eq.className = 'equation-display'; }
    // Update sandbox summary if this is the sandbox
    if (partId === 'sandbox') updateSandboxSummary();
}

// â”€â”€â”€ ANSWER CHECKING â”€â”€â”€
function findPart(partId) {
    for (const prob of PROBLEMS) {
        for (const part of prob.parts) {
            if (part.id === partId) return part;
        }
    }
    return null;
}

function checkAnswer(partId) {
    const part = findPart(partId);
    if (!part) return;
    const s = state[partId];
    const ans = part.answer;
    const fb = document.getElementById(`fb-${partId}`);
    const eq = document.getElementById(`eq-${partId}`);
    let errors = [];
    let allCorrect = true;

    // Check each bar's qualitative pattern â€” use the part's specific bar keys
    const partKeys = getPartAllKeys(part);
    for (const key of partKeys) {
        const expected = ans[key];
        if (expected === undefined) continue; // skip keys not in the answer
        const actual = s[key];
        const label = BAR_LABELS[key];
        if (expected === 'zero' && actual !== 0) {
            errors.push(`${label} should be zero`);
            allCorrect = false;
        } else if (expected === 'pos' && actual <= 0) {
            errors.push(`${label} should be positive (above zero)`);
            allCorrect = false;
        } else if (expected === 'neg' && actual >= 0) {
            errors.push(`${label} should be negative (below zero)`);
            allCorrect = false;
        }
    }

    // Check conservation if applicable
    if (part.conserve && allCorrect) {
        const layout = getPartBarLayout(part);
        const sumInitial = layout.initialBars.reduce((sum, k) => sum + s[k], 0);
        const work = layout.workBars.reduce((sum, k) => sum + s[k], 0);
        const sumFinal = layout.finalBars.reduce((sum, k) => sum + s[k], 0);
        if (Math.abs(sumInitial + work - sumFinal) > 0.01) {
            errors.push(`Energy is not conserved: Initial (${sumInitial}) + Work (${work}) â‰  Final (${sumFinal}). The totals must be equal.`);
            allCorrect = false;
        }
    }

    // Special check for 6a: initial Ug should be greater than final Ug
    if (partId === '6a' && allCorrect && s.iUg <= s.fUg) {
        errors.push(`Initial U<sub>g</sub> should be greater than final U<sub>g</sub> (the jumper falls to a lower height)`);
        allCorrect = false;
    }

    // Display feedback
    if (allCorrect) {
        fb.className = 'feedback show correct';
        fb.innerHTML = 'âœ“ Correct! Well done.';
        completed.add(partId);
    } else {
        fb.className = 'feedback show incorrect';
        fb.innerHTML = '<strong>Not quite.</strong> Check these issues:<br>â€¢ ' + errors.join('<br>â€¢ ');
        if (part.hint) fb.innerHTML += `<br><span class="hint-text">Hint: ${part.hint}</span>`;
        completed.delete(partId);
    }

    // Always show equation after checking
    eq.className = 'equation-display show';
    let eqHTML = `<span class="eq-label">Energy Conservation Equation:</span> &nbsp; ${part.eq}`;
    if (part.hint && allCorrect) eqHTML += `<br><span class="hint-text">${part.hint}</span>`;
    // Special note for 3b
    if (!part.conserve) {
        eqHTML += `<br><span class="hint-text">Note: ${part.hint}</span>`;
    }
    eq.innerHTML = eqHTML;

    updateProgress();
    updateProblemStatuses();
}

function resetPart(partId) {
    state[partId] = { iUg:0, iUs:0, iK:0, iEchem:0, wext:0, fUg:0, fUs:0, fK:0, fQ:0 };
    completed.delete(partId);
    // Re-render just this part
    const part = findPart(partId);
    if (!part) return;
    const partKeys = getPartAllKeys(part);
    partKeys.forEach(k => updateColumn(partId, k));
    const fb = document.getElementById(`fb-${partId}`);
    if (fb) { fb.className = 'feedback'; fb.innerHTML = ''; }
    const eq = document.getElementById(`eq-${partId}`);
    if (eq) { eq.className = 'equation-display'; }
    updateProgress();
    updateProblemStatuses();
}

function resetAll() {
    if (!confirm('Reset all problems? This will clear all your work.')) return;
    PROBLEMS.forEach(prob => prob.parts.forEach(part => {
        state[part.id] = { iUg:0, iUs:0, iK:0, iEchem:0, wext:0, fUg:0, fUs:0, fK:0, fQ:0 };
        completed.delete(part.id);
    }));
    renderAll();
}

function updateProgress() {
    const total = PROBLEMS.reduce((sum, p) => sum + p.parts.length, 0);
    const done = completed.size;
    const pct = total > 0 ? (done / total * 100) : 0;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressText').textContent = `${done} / ${total}`;
}

function updateProblemStatuses() {
    PROBLEMS.forEach(prob => {
        const el = document.getElementById(`status-${prob.id}`);
        if (!el) return;
        const completedParts = prob.parts.filter(p => completed.has(p.id)).length;
        const totalParts = prob.parts.length;
        if (completedParts === totalParts) {
            el.className = 'problem-status complete';
            el.textContent = 'âœ“ Complete';
        } else {
            el.className = 'problem-status incomplete';
            el.textContent = `${completedParts}/${totalParts}`;
        }
    });
}

// â”€â”€â”€ SANDBOX â”€â”€â”€
function renderSandbox() {
    const sandbox = document.getElementById('sandbox');
    const partId = 'sandbox';
    initState(partId);
    const part = { id: partId, allowNeg: true };
    const s = state[partId];
    const sumI = s.iUg + s.iUs + s.iK;
    const sumF = s.fUg + s.fUs + s.fK + s.fQ;
    const balanced = (sumI + s.wext) === sumF;
    sandbox.innerHTML = renderBarChart(part) +
        `<div class="part-actions"><button class="reset-btn" onclick="resetPart('sandbox');renderSandbox()">Reset</button></div>
         <div id="sandbox-summary" style="margin-top:8px;font-size:0.8em;color:var(--text-muted)">
            Initial: ${sumI} &nbsp;|&nbsp;
            Work: ${s.wext} &nbsp;|&nbsp;
            Final: ${sumF} &nbsp;|&nbsp;
            Balanced: ${balanced ? 'âœ“ Yes' : 'âœ— No'}
         </div>`;
}

function updateSandboxSummary() {
    const el = document.getElementById('sandbox-summary');
    if (!el) return;
    const s = state['sandbox'];
    if (!s) return;
    const sumI = s.iUg + s.iUs + s.iK;
    const sumF = s.fUg + s.fUs + s.fK + s.fQ;
    const balanced = (sumI + s.wext) === sumF;
    el.innerHTML = `Initial: ${sumI} &nbsp;|&nbsp; Work: ${s.wext} &nbsp;|&nbsp; Final: ${sumF} &nbsp;|&nbsp; Balanced: ${balanced ? 'âœ“ Yes' : 'âœ— No'}`;
}

// â”€â”€â”€ THEME â”€â”€â”€
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    try { localStorage.setItem('theme', next); } catch(e) {}
}
(function() {
    try {
        const saved = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', saved);
    } catch(e) {}
})();

// â”€â”€â”€ INIT â”€â”€â”€
renderAll();
</script>
</body>
</html>